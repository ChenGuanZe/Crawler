# Game 项目宝塔部署指南

## 一、项目概述

本项目包含以下 6 个 Spring Boot 微服务：

| 模块名称 | 端口 | Context Path | 描述 |
|---------|------|--------------|------|
| game-proxy | 8085 | /gameProxy | 游戏代理服务（核心） |
| TigerTeeth | 8021 | /tigerTeeth | 虎牙游戏服务 |
| bettaFish | 8015 | / | 斗鱼直播服务 |
| game-cnydh | 8082 | / | 超能运动会服务 |
| game-lf | 8088 | / | 灵宠召唤服务 |
| game-yk | 8089 | / | 灵宠召唤/银河之旅（盈科）服务 |

**技术栈：**
- Java 1.8
- Spring Boot 2.2.13.RELEASE
- Redis（game-proxy 需要）

---

## 二、服务器环境准备

### 2.1 服务器要求
- 操作系统：CentOS 7.x / Ubuntu 18.04+
- 内存：建议 4GB+
- 硬盘：建议 50GB+
- 带宽：建议 5Mbps+

### 2.2 安装宝塔面板

```bash
# CentOS 安装命令
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec

# Ubuntu/Debian 安装命令
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

安装完成后，记录面板地址、用户名和密码。
 外网ipv4面板地址: https://8.218.223.24:29627/aca21729
 内网面板地址:     https://172.24.121.218:29627/aca21729
 username: xpfv1cjz
 password: df935d3c

---

## 三、宝塔面板软件安装

### 3.1 登录宝塔面板

浏览器访问：`http://服务器IP:8888/面板入口`

### 3.2 安装必要软件

进入【软件商店】，安装以下软件：

| 软件名称 | 版本要求 | 必要性 |
|---------|---------|-------|
| Nginx | 1.20+ | 必须 |
| Java项目一键部署 | 最新 | 必须 |
| Redis | 6.0+ | 必须（game-proxy依赖） |

#### 安装 JDK 1.8
1. 软件商店 → 搜索 "Java项目一键部署" → 安装
2. 安装完成后点击【设置】→【版本管理】
3. 安装 JDK 1.8（OpenJDK 或 Oracle JDK）

#### 安装 Redis
1. 软件商店 → 搜索 "Redis" → 安装
2. 安装完成后点击【设置】
3. 配置 Redis：
   - 修改端口为 `63379`（与 game-proxy 配置一致）
   - 设置密码为 `Aa12345678`
   - 点击【保存】并【重启】

---

## 四、项目打包

### 4.1 本地打包

在本地开发环境中，进入每个项目目录执行 Maven 打包：

```bash
# 打包 game-proxy
cd game-proxy
mvn clean package -DskipTests

# 打包 TigerTeeth
cd ../TigerTeeth
mvn clean package -DskipTests

# 打包 bettaFish
cd ../bettaFish
mvn clean package -DskipTests

# 打包 game-cnydh
cd ../game-cnydh
mvn clean package -DskipTests

# 打包 game-lf
cd ../game-lf
mvn clean package -DskipTests

# 打包 game-yk
cd ../game-yk
mvn clean package -DskipTests
```

### 4.2 打包产物位置

| 模块 | JAR 包路径 | JAR 包名称 |
|-----|-----------|-----------|
| game-proxy | target/game-proxy-1.0.jar | game-proxy-1.0.jar |
| TigerTeeth | target/game-hy.jar | game-hy.jar |
| bettaFish | target/bettaFish-1.0-SNAPSHOT.jar | bettaFish.jar |
| game-cnydh | target/game-cnydh.jar | game-cnydh.jar |
| game-lf | target/game-lf-1.0.jar | game-lf.jar |
| game-yk | target/game-yk.jar | game-yk.jar |

---

## 五、上传 JAR 包

### 5.1 创建部署目录

在宝塔【文件】中创建以下目录结构：

```
/www/wwwroot/game/
├── game-proxy/
│   └── game-proxy-1.0.jar
├── tiger-teeth/
│   └── game-hy.jar
├── betta-fish/
│   └── bettaFish.jar
├── game-cnydh/
│   └── game-cnydh.jar
├── game-lf/
│   └── game-lf.jar
├── game-yk/
│   └── game-yk.jar
└── logs/
```

### 5.2 上传文件

1. 宝塔面板 → 【文件】
2. 进入 `/www/wwwroot/game/` 目录
3. 点击【上传】，将各 JAR 包上传到对应目录

---

## 六、配置 Java 项目

### 6.1 添加 Java 项目

在宝塔面板中：

1. 点击【网站】→【Java项目】→【添加Java项目】

### 6.2 配置各服务

#### 服务1：game-proxy（核心服务）

| 配置项 | 值 |
|-------|-----|
| 项目名称 | game-proxy |
| 项目jar路径 | /www/wwwroot/game/game-proxy/game-proxy-1.0.jar |
| 项目端口 | 8085 |
| JDK版本 | JDK 1.8 |
| 启动参数 | -Xms256m -Xmx512m -Dspring.profiles.active=prod |

#### 服务2：TigerTeeth（虎牙服务）

| 配置项 | 值 |
|-------|-----|
| 项目名称 | tiger-teeth |
| 项目jar路径 | /www/wwwroot/game/tiger-teeth/game-hy.jar |
| 项目端口 | 8021 |
| JDK版本 | JDK 1.8 |
| 启动参数 | -Xms128m -Xmx256m |

#### 服务3：bettaFish（斗鱼服务）

| 配置项 | 值 |
|-------|-----|
| 项目名称 | betta-fish |
| 项目jar路径 | /www/wwwroot/game/betta-fish/bettaFish.jar |
| 项目端口 | 8015 |
| JDK版本 | JDK 1.8 |
| 启动参数 | -Xms128m -Xmx256m |

#### 服务4：game-cnydh（超能运动会）

| 配置项 | 值 |
|-------|-----|
| 项目名称 | game-cnydh |
| 项目jar路径 | /www/wwwroot/game/game-cnydh/game-cnydh.jar |
| 项目端口 | 8082 |
| JDK版本 | JDK 1.8 |
| 启动参数 | -Xms128m -Xmx256m |

#### 服务5：game-lf（灵宠召唤）

| 配置项 | 值 |
|-------|-----|
| 项目名称 | game-lf |
| 项目jar路径 | /www/wwwroot/game/game-lf/game-lf.jar |
| 项目端口 | 8088 |
| JDK版本 | JDK 1.8 |
| 启动参数 | -Xms128m -Xmx256m |

#### 服务6：game-yk（灵宠召唤/银河之旅-盈科）

| 配置项 | 值 |
|-------|-----|
| 项目名称 | game-yk |
| 项目jar路径 | /www/wwwroot/game/game-yk/game-yk.jar |
| 项目端口 | 8089 |
| JDK版本 | JDK 1.8 |
| 启动参数 | -Xms128m -Xmx256m |

---

## 七、Nginx 反向代理配置（可选）

如果需要通过域名访问，配置 Nginx 反向代理：

### 7.1 添加网站

1. 【网站】→【添加站点】
2. 填写域名（如：game.yourdomain.com）
3. PHP版本选择"纯静态"

### 7.2 配置反向代理

点击网站【设置】→【配置文件】，添加以下配置：

```nginx
# 游戏代理服务
location /gameProxy/ {
    proxy_pass http://127.0.0.1:8085/gameProxy/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
}

# 虎牙服务
location /tigerTeeth/ {
    proxy_pass http://127.0.0.1:8021/tigerTeeth/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 斗鱼服务
location /bettaFish/ {
    proxy_pass http://127.0.0.1:8015/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 超能运动会服务
location /cnydh/ {
    proxy_pass http://127.0.0.1:8082/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 灵宠召唤服务
location /gamelf/ {
    proxy_pass http://127.0.0.1:8088/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 盈科游戏服务
location /gameyk/ {
    proxy_pass http://127.0.0.1:8089/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

---

## 八、防火墙配置

### 8.1 宝塔防火墙

在宝塔【安全】中放行以下端口：

| 端口 | 服务 |
|-----|------|
| 8085 | game-proxy |
| 8021 | TigerTeeth |
| 8015 | bettaFish |
| 8082 | game-cnydh |
| 8088 | game-lf |
| 8089 | game-yk |
| 63379 | Redis（仅内网） |

### 8.2 服务器防火墙

```bash
# CentOS 7
firewall-cmd --permanent --add-port=8085/tcp
firewall-cmd --permanent --add-port=8021/tcp
firewall-cmd --permanent --add-port=8015/tcp
firewall-cmd --permanent --add-port=8082/tcp
firewall-cmd --permanent --add-port=8088/tcp
firewall-cmd --permanent --add-port=8089/tcp
firewall-cmd --reload

# 或者直接关闭防火墙（不推荐生产环境）
systemctl stop firewalld
systemctl disable firewalld
```

---

## 九、启动服务

### 9.1 启动顺序

**重要**：按以下顺序启动服务：

1. 首先确保 Redis 已启动
2. 启动 game-proxy（核心服务）
3. 启动其他服务（顺序不限）

### 9.2 在宝塔中启动

1. 【网站】→【Java项目】
2. 找到对应项目，点击【启动】按钮
3. 查看状态变为"运行中"

### 9.3 命令行启动（备用）

```bash
# 启动 game-proxy
cd /www/wwwroot/game/game-proxy
nohup java -Xms256m -Xmx512m -jar game-proxy-1.0.jar > /www/wwwroot/game/logs/game-proxy.log 2>&1 &

# 启动 tiger-teeth
cd /www/wwwroot/game/tiger-teeth
nohup java -Xms128m -Xmx256m -jar game-hy.jar > /www/wwwroot/game/logs/tiger-teeth.log 2>&1 &

# 启动 betta-fish
cd /www/wwwroot/game/betta-fish
nohup java -Xms128m -Xmx256m -jar bettaFish.jar > /www/wwwroot/game/logs/betta-fish.log 2>&1 &

# 启动 game-cnydh
cd /www/wwwroot/game/game-cnydh
nohup java -Xms128m -Xmx256m -jar game-cnydh.jar > /www/wwwroot/game/logs/game-cnydh.log 2>&1 &

# 启动 game-lf
cd /www/wwwroot/game/game-lf
nohup java -Xms128m -Xmx256m -jar game-lf.jar > /www/wwwroot/game/logs/game-lf.log 2>&1 &

# 启动 game-yk
cd /www/wwwroot/game/game-yk
nohup java -Xms128m -Xmx256m -jar game-yk.jar > /www/wwwroot/game/logs/game-yk.log 2>&1 &
```

---

## 十、验证部署

### 10.1 检查服务状态

```bash
# 查看所有 Java 进程
ps -ef | grep java

# 查看端口占用
netstat -tlnp | grep -E "8085|8021|8015|8082|8088|8089"
```

### 10.2 接口测试

```bash
# 测试 game-proxy
curl http://127.0.0.1:8085/gameProxy/proxy/yhtxGameInfo

# 测试 TigerTeeth
curl http://127.0.0.1:8021/tigerTeeth/

# 测试其他服务
curl http://127.0.0.1:8015/
curl http://127.0.0.1:8082/
curl http://127.0.0.1:8088/
curl http://127.0.0.1:8089/
```

---

## 十一、日志查看

### 11.1 宝塔查看

【网站】→【Java项目】→ 对应项目 →【日志】

### 11.2 命令行查看

```bash
# 实时查看日志
tail -f /www/wwwroot/game/logs/game-proxy.log

# 查看最近 100 行
tail -100 /www/wwwroot/game/logs/game-proxy.log
```

---

## 十二、常见问题

### Q1: 服务启动失败，提示端口被占用

```bash
# 查找占用端口的进程
lsof -i:8085
# 杀死进程
kill -9 <PID>
```

### Q2: Redis 连接失败

1. 检查 Redis 是否启动：`systemctl status redis`
2. 检查 Redis 端口是否正确：63379
3. 检查 Redis 密码是否正确：Aa12345678

### Q3: Java 内存不足

调整启动参数中的内存配置：
```
-Xms512m -Xmx1024m
```

### Q4: 服务无法访问

1. 检查防火墙是否放行端口
2. 检查云服务器安全组是否放行端口
3. 检查服务是否正常启动

---

## 十三、维护命令

```bash
# 停止所有 Java 服务
pkill -f "java.*game"

# 重启 Redis
systemctl restart redis

# 查看系统资源占用
top
free -h
df -h

# 清理日志（保留最近 7 天）
find /www/wwwroot/game/logs -name "*.log" -mtime +7 -delete
```

---

## 十四、自动重启配置

在宝塔【计划任务】中添加定时任务，确保服务异常退出后自动重启：

```bash
#!/bin/bash
# 检查并重启服务

check_and_start() {
    local name=$1
    local port=$2
    local jar=$3
    local log=$4
    
    if ! netstat -tlnp | grep -q ":$port"; then
        echo "$(date) - $name 未运行，正在启动..."
        cd $(dirname $jar)
        nohup java -Xms128m -Xmx256m -jar $(basename $jar) > $log 2>&1 &
    fi
}

check_and_start "game-proxy" 8085 "/www/wwwroot/game/game-proxy/game-proxy-1.0.jar" "/www/wwwroot/game/logs/game-proxy.log"
check_and_start "tiger-teeth" 8021 "/www/wwwroot/game/tiger-teeth/game-hy.jar" "/www/wwwroot/game/logs/tiger-teeth.log"
check_and_start "betta-fish" 8015 "/www/wwwroot/game/betta-fish/bettaFish.jar" "/www/wwwroot/game/logs/betta-fish.log"
check_and_start "game-cnydh" 8082 "/www/wwwroot/game/game-cnydh/game-cnydh.jar" "/www/wwwroot/game/logs/game-cnydh.log"
check_and_start "game-lf" 8088 "/www/wwwroot/game/game-lf/game-lf.jar" "/www/wwwroot/game/logs/game-lf.log"
check_and_start "game-yk" 8089 "/www/wwwroot/game/game-yk/game-yk.jar" "/www/wwwroot/game/logs/game-yk.log"
```

执行周期：每 5 分钟

---

## 部署检查清单

- [ ] 宝塔面板已安装
- [ ] JDK 1.8 已安装
- [ ] Redis 已安装并配置
- [ ] 所有 JAR 包已上传
- [ ] 防火墙端口已放行
- [ ] 所有服务已启动
- [ ] 接口测试通过
- [ ] 自动重启任务已配置
